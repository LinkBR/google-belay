<!doctype html>
<html>
<head>
  <script src="lib/js/caps.js"></script>
</head>

<body>
I am the Belay frame.
<ol id="log">
</ol>

<script>
function log(args) {
  if (!(args instanceof Array)) {
    args = [args];
  }

  var arr = [];

  for (var i = 0; i < args.length; i++) {
    arr.push(typeof args[i] === 'string' ? args[i] 
                                        : JSON.stringify(args[i]));
  }

  var txt = document.createTextNode(arr.join(' '));
  var li = document.createElement('li');
  li.appendChild(txt);
  document.getElementById('log').appendChild(li);
  console.log.apply(console, args);
  document.body.scrollTop = document.body.scrollHeight;
}


var iframeInstID = newUUIDv4();
var iframeServer = new CapServer(iframeInstID);

var clientInstID;
var clientTunnel;
var clientLocation;
var actionPort;

var workerTunnel;

function resolver(instID) {
  if (instID === iframeInstID) { return iframeServer.publicInterface; }
  if (instID === clientInstID) { return clientTunnel.sendInterface; }
  return workerTunnel.sendInterface;
}

iframeServer.setResolver(resolver);

var worker = new SharedWorker('shared-worker.js');
function setUpWorker(e) {
  worker.port.removeEventListener('message', setUpWorker);
  workerTunnel = new CapTunnel(worker.port);
  workerTunnel.setLocalResolver(resolver);
  startIfReady();
  log('worker tunnel ready');
}
worker.port.addEventListener('message', setUpWorker);
worker.port.start();

function setUpClient(e) {
  window.removeEventListener(setUpClient);
  clientTunnel = new CapTunnel(e.ports[0]);
  actionPort = e.ports[1];
  clientTunnel.setLocalResolver(resolver);
  clientLocation = e.data;
  startIfReady();
  log('client tunnel ready');
}
window.addEventListener('message', setUpClient);

function startIfReady() {
  if (!workerTunnel || !clientTunnel) return;
  log("frame: " + iframeInstID);
  
  var outpostMsg = {
    iframeInstID: iframeInstID,
    clientLocation: clientLocation,
    log: iframeServer.grant(log),
    localStorage: iframeServer.grant({
        get: function() { 
          return iframeServer.dataPostProcess(localStorage['belay'] ||
                                              '{ "value": { } }');
        },
        put: function(v) { 
          localStorage['belay'] = iframeServer.dataPreProcess(v);
        }
      }),
    windowOpen: iframeServer.grant(function(url) { window.open(url); }),
    windowClose: iframeServer.grant(function() {
      actionPort.postMessage('close');
    }),
    windowLocation: iframeServer.grant(function(url) { 
      window.top.location = url; 
    }),
    setUpClient: iframeServer.grant(function(v) {
      clientInstID = v.instID;
      log("client: " + clientInstID);
      clientTunnel.sendOutpost(iframeServer.dataPreProcess(v.outpost));
    })
  };
  workerTunnel.sendOutpost(iframeServer.dataPreProcess(outpostMsg));
}
</script>
</body>

</html>
