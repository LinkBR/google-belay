<!DOCTYPE html>
<html>
<head>
  <script src="lib/js/caps.js"></script>
  <script src="caprouter.js"></script>
<style type='text/css'>

#log {
 font-family: Consolas, fixed;
 font-size: 10pt;
 background-color: black;
 color: white;
 max-height: 200px;
 overflow-y: scroll;
}

#log div {
  border-bottom: 1px solid gray;
}

.suggestButton {
  padding-left: 0.5em;
  padding-right: 0.5em;
  -webkit-appearance: square-button;
}

#closeButton {
  float: right;
  font-size: larger;
}

body {
  background-color: #ffffcc;
}

</style>
</head>

<body>
<span id="closeButton">&otimes;</span>
<div id="suggestButtons"></div>
<div id="debug" style="display: none">
  <button id="clearButton">Clear localStorage</button>
  <div id="log"></div>
</div>
<script>

'use strict';

function log(args) {
  if (!(args instanceof Array)) {
    args = [args];
  }

  var arr = [];

  for (var i = 0; i < args.length; i++) {
    arr.push(typeof args[i] === 'string' ? args[i] 
                                        : JSON.stringify(args[i]));
  }

  var txt = document.createTextNode(arr.join(' '));
  var li = document.createElement('div');
  li.appendChild(txt);
  var logElt = document.getElementById('log');
  logElt.appendChild(li);
  console.log.apply(console, args);
  logElt.scrollTop = logElt.scrollHeight;
}


var iframeInstanceId = newUUIDv4();
var iframeServer = new CapServer(iframeInstanceId);

var clientTunnel;
var actionPort;


var router = new CapRouter();
router.addInterface(iframeInstanceId, iframeServer.publicInterface);
iframeServer.setResolver(router.resolver);


var navigateCap = iframeServer.grant(function(args) { 
  actionPort.postMessage({ op: 'navigate', args: args });
});
var closeCap = iframeServer.grant(function() {
  actionPort.postMessage('close');
});


var setStationCallbacksCap = iframeServer.grant(function(stationCallbacks) {
  function newInstHandler(v) {
    if ('newInstHandler' in stationCallbacks) {
      stationCallbacks.newInstHandler.post({
        instanceDescription: v.instanceDescription,
        activate: buildActivateCap(v.navigate)
      });
    }
    else {
      // TODO(mzero): station can't handle this - what now?
    }
  }
  
  function getSuggestions(location, success, failure) {
    if ('getSuggestions' in stationCallbacks) {
      stationCallbacks.getSuggestions.post(location, function(suggestions) {
        success({
          suggestions: suggestions,
          doLaunchActivate: iframeServer.grant(function(v) {
            v.doLaunch.post(buildActivateCap(v.navigate));
          })
        });
      },
      failure);
    }
    else {
      // TODO(mzero): station can't handle this - what now?
      success({suggestions:[]});
    }
  }
  
  localStorage.setItem('station.newInstHandler',
    iframeServer.grant(newInstHandler).serialize());
  localStorage.setItem('station.getSuggestions',
    iframeServer.grant(getSuggestions).serialize());
});

var failureCap = iframeServer.grant(function(v, success, failure) {
  failure({status: 404 });
});

function stationCap(key) {
  var ser = localStorage.getItem('station.' + key);
  return ser ? iframeServer.restore(ser) : failureCap;
}


var highlightingCaps = {
  highlightByRC: iframeServer.grant(function(v) {
    localStorage.setItem('highlight', JSON.stringify(v));
    actionPort.postMessage({ op: 'highlight', args: v });
  }),
  unhighlight: iframeServer.grant(function() {
    localStorage.removeItem('highlight');
    actionPort.postMessage('unhighlight');
  })
};

window.addEventListener('storage', function(e) {
  // NOTE: setting localStorage doesn't fire events on setting document,
  // so code above must make these same calls as well.
  if (e.key == 'highlight') {
    if (e.newValue) {
      var v = JSON.parse(e.newValue);
      actionPort.postMessage({ op: 'highlight', args: v });
    }
    else {
      actionPort.postMessage('unhighlight');
    }
  }
}, false);


function MessageChannelComms(remoteWindow, origin, handleInit, firstEvent) {
  if (handleInit) {
    handleInit({
      belayPort: firstEvent.ports[0],
      actionPort: firstEvent.ports[1],
      initData: firstEvent.data
    })
  } else {
    var belayChan = new MessageChannel();
    var actionChan = new MessageChannel();

    return {
      belayPort: belayChan.port1,
      actionPort: actionChan.port1,
      postInit: function(msg) {
        remoteWindow.postMessage(
          msg,
          // two following args. backward for Chrome and Safari
          [belayChan.port2, actionChan.port2],
          origin);
      }
    };
  }
}

function MultiplexedComms(remoteWindow, origin, handleInit, firstEvent) {
  var ConcentratedPort = function(id) {
    this.id = id;
    this.onmessage = null;
  };
  ConcentratedPort.prototype.postMessage = function(data) {
    remoteWindow.postMessage({ id: this.id, data: data }, origin);
  };
  
  var ports = {
    belay: new ConcentratedPort('belay'),
    action: new ConcentratedPort('action')
  }
  
  function handleEvent(e) {
    if (e.source != remoteWindow) { return; }
    if (e.origin != origin && origin != '*') { return; }
    if (e.data.id in ports) {
      var onmessage = ports[e.data.id].onmessage;
      if (onmessage) { onmessage({ data: e.data.data }); }
    }
    else if (handleInit && e.data.id == 'init') {
      handleInit({
        belayPort: ports.belay,
        actionPort: ports.action,
        initData: e.data.data
      });
    }
    e.stopPropagation();
  }
  
  window.addEventListener('message', handleEvent, false);
  if (handleInit) {
    handleEvent(firstEvent)
  } else {
    return {
      belayPort: ports.belay,
      actionPort: ports.action,
      postInit: function(msg) {
        remoteWindow.postMessage({ id: 'init', data: msg }, origin)            
      }
    }        
  }
}


window.addEventListener('message', setUpClient);

function setUpClient(e) {
  window.removeEventListener('message', setUpClient);

  function init(comms) {
    clientTunnel = new CapTunnel(comms.belayPort);
    actionPort = comms.actionPort;
    clientTunnel.setLocalResolver(router.resolver);
    var clientLocation = comms.initData.clientLocation;
    var clientStartId = comms.initData.clientStartId;
    window.DEBUG = comms.initData.DEBUG;
    if (window.DEBUG) {
      actionPort.postMessage('showButterBar'); 
      document.getElementById('debug').style.display = 'block';
    }

    var instruction = router.retrieveStart(clientStartId);
    if (instruction === null) {
      setupFreshPage();
      checkForSuggestions(clientLocation);
    }
    else if ('startLaunch' in instruction) {
      instruction.startLaunch.post(navigateCap);
    }
    else if ('finishLaunch' in instruction) {
      instruction.finishLaunch.post(closeCap, setupLaunchedPage);
    }
    else {
      // unknown start instruction
    }    
  }

  ('MessageChannel' in window
      ? MessageChannelComms
      : MultiplexedComms)(window.parent, '*', init, e);
}

function expectPage(expect) {
  var startCap = iframeServer.grant(function(navigate) {
    expect.ready.post(buildActivateCap(navigate));
  });
  router.storeStart(expect.startId, { startLaunch: startCap });
}

var expectCap = iframeServer.grant(expectPage);

function buildActivateCap(navigateCap) {
  return iframeServer.grant(function(args, success, failure) {
    var finishCap = iframeServer.grant(function(close) {
      success(close);
      var pending = {
        instanceId: args.instanceId,
        temporaryInstance: false,
        outpost: args.outpostData,
        isStation: args.isStation || false,
      };
      
      if('relaunch' in args) {
        var relaunch = args.relaunch;
        pending.relaunch = iframeServer.grant(function(navigateCap) {
          relaunch.post(buildActivateCap(navigateCap));
        });
      };
      return pending;
    });
    
    var startId = newUUIDv4();
    router.storeStart(startId, { finishLaunch: finishCap });
    navigateCap.post({url: args.pageUrl, startId: startId});
  });
}

function setupLaunchedPage(pending) {
  if (pending.isStation) {
    pending.outpost.setStationCallbacks = setStationCallbacksCap;
    pending.outpost.services = highlightingCaps;
  }
  pending.outpost.expectPage = expectCap;

  router.addInterface(pending.instanceId, clientTunnel.sendInterface);
  
  if('relaunch' in pending) {
    window.sessionStorage['relaunch'] = pending.relaunch.serialize();
  }
  clientTunnel.sendOutpost(pending.outpost);
}

function setupFreshPage() {
  if('relaunch' in window.sessionStorage) {
    var relaunch = iframeServer.restore(window.sessionStorage['relaunch']);
    delete (window.sessionStorage)['relaunch']
    relaunch.post(navigateCap);
      // TODO(iainmcgin): should handle failure here and do something nice
    return;
  }

  // client might want to become an instance or the station
  var tempInstanceId = newUUIDv4();
  router.addInterface(tempInstanceId, clientTunnel.sendInterface);
  
  var outpost = {
    instanceId: tempInstanceId,
    temporaryInstance: true,
    becomeInstance: iframeServer.grant(function(instanceDescription) {
      stationCap('newInstHandler').post({
        instanceDescription: instanceDescription,
        navigate: navigateCap
      });
    }),
    expectPage: expectCap,
    services: highlightingCaps
  };
  
  clientTunnel.sendOutpost(outpost);
}


function checkForSuggestions(location, showSuggestions, navigate) {
  var m = location.match('^https?://[^/]*');
  if (m === null) return;
  location = m[0];

  stationCap('getSuggestions').post(location, function(v) {
    if (v.suggestions.length == 0) return;
    
    var buttonContainer = document.getElementById('suggestButtons');
    Object.keys(v.suggestions).forEach(function(k) {
      var suggestion = v.suggestions[k];
      var btn = document.createElement('button');
      btn.className = 'suggestButton';
      btn.innerText = suggestion.name;
      buttonContainer.appendChild(btn);
      btn.addEventListener('click', function() {
        v.doLaunchActivate.post({
          doLaunch: suggestion.doLaunch,
          navigate: navigateCap
        });
      });
    });
    actionPort.postMessage('showButterBar');
  });
}


document.getElementById('closeButton').addEventListener('click',
  function() { actionPort.postMessage('hideButterBar'); });
document.getElementById('clearButton').addEventListener('click',
  function() { 
    delete localStorage['belay'];
  });

</script>
</body>

</html>
